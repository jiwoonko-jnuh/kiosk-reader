<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>키오스크 메뉴</title>
    <style>
        body { font-size: 1.2em; }
        .menu-item { margin: 10px 0; }
        .cart-btn, .voice-btn { margin-left: 10px; }
    </style>
</head>
<body>
    <h1>메뉴</h1>
    <div id="menu-list">
        {% for item in menu %}
        <div class="menu-item">
            <span>{{ item.name }} ({{ item.price }}원)</span>
            <button class="cart-btn" onclick="addToCart('{{ item.id }}')">장바구니 담기</button>
        </div>
        {% endfor %}
    </div>
    <br><br>
    <a href="/cart">장바구니 보기</a>

    <script>
    function addToCart(id) {
        fetch('/add_to_cart', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id })
        })
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                const msg = new SpeechSynthesisUtterance('장바구니에 담았습니다.');
                msg.lang = 'ko-KR';
                window.speechSynthesis.speak(msg);

            } else {
                alert(data.message);
            }
        });
    }

    window.onload = function() {
        startVoiceRecognition();
    }

    function startVoiceRecognition() {
        if (!('webkitSpeechRecognition' in window)) {
            alert('이 브라우저는 음성인식을 지원하지 않습니다.');
            return;
        }
        const recognition = new webkitSpeechRecognition();
        recognition.lang = 'ko-KR';
        recognition.start();
        recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript;
            const menu = JSON.parse('{{ menu|tojson|safe }}');

            // 결제 명령
            if (transcript.includes('결제')) {
                window.location.href = '/cart';
                const msg = new SpeechSynthesisUtterance('장바구니에서 결제 버튼을 눌러주세요.');
                msg.lang = 'ko-KR';
                window.speechSynthesis.speak(msg);
                return;
            }
            // 장바구니 보기
            if (transcript.includes('장바구니') || transcript.includes('카트') || transcript.includes('내역') || transcript.includes('주문내역')) {
                window.location.href = '/cart';
                const msg = new SpeechSynthesisUtterance('장바구니로 이동합니다.');
                msg.lang = 'ko-KR';
                window.speechSynthesis.speak(msg);
                return;
            }

            // 메뉴 담기
            const found = menu.find(item => transcript.includes(item.name));
            if(found) {
                addToCart(found.id);
                const msg = new SpeechSynthesisUtterance(found.name + '를 장바구니에 담았습니다.');
                msg.lang = 'ko-KR';
                window.speechSynthesis.speak(msg);
            } else {
                //chatGPT api로 잘못된 발음 교정 / 메뉴 추천
                const message = [
                    { role: 'system', content:'답변은 항상 한국어로, 메뉴 이름만 말해주세요. 사용자가 발음을 실수 했다고 판단될 경우 정확한 제품명을, 그렇지 않은 경우 사용자의 요구에 맞춰 답하세요. 메뉴는 아메리카노, 카페라떼, 녹차, 샌드위치 가 있습니다.'},
                    { role: 'user', content: transcript}
                ]
                const gptInput = {
                    model: 'gpt-3.5-turbo',
                    temperature: 0.5,
                    messages: message 
                }

                const APIKEY = "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";
                const CallGPT = async (gptInput) => {
                    try {
                        const response = await fetch('https://api.openai.com/v1/chat/completions', {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "Authorization": `Bearer ${APIKEY}`
                            },
                            body: JSON.stringify(gptInput)
                        });

                        const resultJSON = await response.json();

                        const resultContent = resultJSON.choices[0].message.content;

                        return resultContent;

                    } catch (error) {
                        console.error('Error:', error);
                        return "오류가 발생했습니다."
                    }
                }
                CallGPT(gptInput).then(resultContent => {
                    const msg = new SpeechSynthesisUtterance(resultContent);
                    msg.lang = 'ko-KR';
                    window.speechSynthesis.speak(msg);
                });
            }
        };
        recognition.onerror = function(event) {
            const msg = new SpeechSynthesisUtterance('음성인식에 실패했습니다. 다시 시도해 주세요.');
            msg.lang = 'ko-KR';
            window.speechSynthesis.speak(msg);
        };
    }
    </script>
</body>
</html>
